name: CF-DNS-Update-Emby
on:
  schedule:
    - cron: '*/30 * * * *'  # 每30分钟执行（UTC时间）
  workflow_dispatch:        # 手动触发（试运行用这个）

jobs:
  update-dns:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：安装唯一必要工具bc（极简）
      - name: 安装基础工具
        run: sudo apt update -y && sudo apt install -y bc || true

      # 步骤2：获取最快且支持Emby的CF IP（核心逻辑极简）
      - name: 筛选CF IP
        id: get-ip
        run: |
          # 你的CF IP列表（保留少量稳定IP）
          ips=(
            "172.64.229.141"
            "162.159.58.102"
            "172.64.42.0"
          )
          fastest_ip="172.64.229.141"  # 默认IP
          max_speed=0
          EMBY_DOMAIN="gzxgzxgzx.de5.net"

          # 循环测试IP
          for ip in "${ips[@]}"; do
            echo "测试IP: $ip"
            # 1. 验证是否支持Emby（仅用curl，无复杂判断）
            if curl -s --connect-timeout 5 --max-time 10 \
              --resolve "$EMBY_DOMAIN:443:$ip" \
              "https://$EMBY_DOMAIN/emby/System/Info/Public" > /dev/null; then
              echo "IP $ip 支持Emby"
              # 2. 测速（用CF官方5MB文件，极简）
              speed=$(curl -o /dev/null -s -w "%{speed_download}" \
                --connect-timeout 5 --max-time 10 \
                "http://speed.cloudflare.com/__down?bytes=5242880" || echo 0)
              # 记录最快IP
              if (( $(echo "$speed > $max_speed" | bc -l) )); then
                max_speed=$speed
                fastest_ip=$ip
              fi
            else
              echo "IP $ip 不支持Emby，跳过"
            fi
          done

          echo "fast_ip=$fastest_ip" >> $GITHUB_OUTPUT
          echo "选中IP: $fastest_ip"

      # 步骤3：更新Cloudflare DNS（单行JSON，无格式坑）
      - name: 更新DNS记录
        run: |
          # 调用CF API更新DNS（极简版）
          curl -X PUT "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/dns_records/${{ secrets.CF_RECORD_ID }}" \
            -H "Authorization: Bearer ${{ secrets.CF_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"type\":\"A\",\"name\":\"gzxgzxgzx.de5.net\",\"content\":\"${{ steps.get-ip.outputs.fast_ip }}\",\"ttl\":1,\"proxied\":true}"
          echo "DNS已更新为: ${{ steps.get-ip.outputs.fast_ip }}"
