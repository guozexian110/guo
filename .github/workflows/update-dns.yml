name: CF-DNS-Update-Emby
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  update-dns:
    runs-on: ubuntu-latest
    steps:
      - name: 安装基础工具
        run: sudo apt update -y && sudo apt install -y bc || true

      - name: 筛选CF IP（显示测速数据）
        id: get-ip
        run: |
          # 你的CF IP列表
          ips=(
            "172.64.229.141"
            "162.159.58.102"
            "172.64.42.0"
          )
          fastest_ip="172.64.229.141"  # 默认IP
          max_speed=0
          EMBY_DOMAIN="gzxgzxgzx.de5.net"
          # 测速配置：CF官方5MB文件，绑定测速域名
          TEST_DOMAIN="speed.cloudflare.com"
          TEST_FILE="https://${TEST_DOMAIN}/__down?bytes=5242880"  # 5MB

          for ip in "${ips[@]}"; do
            echo "==== 测试IP: $ip ===="
            # 1. 验证是否支持Emby
            if curl -s --connect-timeout 5 --max-time 10 \
              --resolve "$EMBY_DOMAIN:443:$ip" \
              "https://$EMBY_DOMAIN/emby/System/Info/Public" > /dev/null; then
              echo "→ Emby：支持"
              
              # 2. 精准测速（绑定CF IP到测速域名，确保测的是目标IP）
              speed=$(curl -o /dev/null -s -w "%{speed_download}" \
                --connect-timeout 5 --max-time 10 \
                --resolve "$TEST_DOMAIN:443:$ip" \  # 关键：绑定IP和测速域名
                "$TEST_FILE" || echo 0)
              
              # 3. 转换为MB/s，并打印测速数据（核心：显示数据）
              speed_mb=$(echo "scale=2; $speed / 1024 / 1024" | bc)
              echo "→ 测速速度：$speed_mb MB/s（原始速度：$speed 字节/秒）"
              
              # 4. 对比速度，更新最快IP
              if (( $(echo "$speed > $max_speed" | bc -l) )); then
                max_speed=$speed
                fastest_ip=$ip
                echo "→ 暂选为最快IP（速度超过之前的最大值）"
              fi
            else
              echo "→ Emby：不支持，跳过"
              continue
            fi
          done

          echo "==== 最终结果 ===="
          echo "选中最快IP：$fastest_ip"
          echo "fast_ip=$fastest_ip" >> $GITHUB_OUTPUT

      - name: 更新DNS记录
        run: |
          curl -X PUT "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/dns_records/${{ secrets.CF_RECORD_ID }}" \
            -H "Authorization: Bearer ${{ secrets.CF_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"type\":\"A\",\"name\":\"gzxgzxgzx.de5.net\",\"content\":\"${{ steps.get-ip.outputs.fast_ip }}\",\"ttl\":1,\"proxied\":true}"
          echo "DNS已更新为: ${{ steps.get-ip.outputs.fast_ip }}"
